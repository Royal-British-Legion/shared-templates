name: Create storage account
on:
  workflow_dispatch:

inputs:
  location:
    description: 'Location where the storage account will be created'
    default: uksouth
  unit:
    description: 'Name of the site that this storage account will be used for'
    required: true
  product:
    description: 'Name of the product that we are creating'
    required: true

jobs:
  provisioning:
    runs-on: ubuntu-latest
    env:
      working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Set Bicep config options
        run: |
          az config set bicep.use_binary_from_path=true
      - name: Build Bicep Template
        id: build
        uses: Azure/bicep-build-action@v1.0.0
        with:
          bicepFilePath: ./bicep/main.bicep
          outputFilePath: ./bicep/azuredeploy.json
          parameters: |
            location='${{ inputs.location }}'
      - name: Deploy Storage Account 
        uses: azure/arm-deploy@v1
        with:
          scope: subscription
          region: ${{ inputs.location }}
          template: ./infrastructure/bicep/azuredeploy.json